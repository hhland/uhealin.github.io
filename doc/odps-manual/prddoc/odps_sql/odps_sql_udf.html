<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>自定义函数(UDF) &mdash; ODPS 1.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="ODPS 1.0 documentation" href="../../index.html" />
    <link rel="up" title="ODPS SQL" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="odps_sql_appendix.html" title="附录"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="odps_sql_func.html" title="SQL内建函数"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">ODPS 1.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">ODPS SQL</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="udf">
<span id="odps-sql-udf"></span><h1>自定义函数(UDF)<a class="headerlink" href="#udf" title="Permalink to this headline">¶</a></h1>
<p>UDF全称User Defined Function，即用户自定义函数。ODPS提供了很多内建函数来满足用户的计算需求，同时用户还可以通过创建自定义函数来满足不同的计算需求。UDF在使用上与普通的 <a class="reference internal" href="odps_sql_func.html#odps-sql-function"><em>SQL内建函数</em></a> 类似。目前SQL UDF功能仍处于公测阶段，如果您想使用此功能，可通过阿里云官网获取邀请码。</p>
<p>在ODPS中，用户可以扩展的UDF有两种：</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="48%" />
<col width="52%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">UDF 分类</th>
<th class="head">描述</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>User Defined Scalar Function
通常也称之为UDF</td>
<td>用户自定义标量值函数(User Defined Scalar
Function)通常也称之为UDF。其输入与输出是一对
一的关系，即读入一行数据，写出一条输出值。</td>
</tr>
<tr class="row-odd"><td>UDTF(User Defined Table Valued Function)</td>
<td>自定义表值函数，是用来解决一次函数调用输出多
行数据场景的，也是唯一能返回多个字段的自定义
函数。而UDF只能一次计算输出一条返回值。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">UDF广义的说法代表了标量值函数及表值函数两种类型的自定义函数的集合。狭义来说，仅代表用户标量值函数。文档会经常使用这一名词，请读者根据文档上下文判断具体含义。</p>
</div>
<div class="section" id="odps-sql-udf-quickstart">
<span id="id1"></span><h2>快速开始(UDF的创建和使用)<a class="headerlink" href="#odps-sql-udf-quickstart" title="Permalink to this headline">¶</a></h2>
<p>UDF目前仅支持Java语言接口，用户如果想编写UDF程序，可以通过 <a class="reference internal" href="../odps_common.html#odps-common-add-resource-cmd"><em>创建资源</em></a> 的方式将UDF代码上传到项目空间中，使用 <a class="reference internal" href="../odps_common.html#odps-common-create-func"><em>创建函数</em></a> 语句创建UDF。在使用UDF时，其使用方式与普通的SQL内建函数一致。</p>
<p>下面我们将给出一个完整的开发UDF流程示例，例如实现一个字符小写转换功能的UDF，需要经过如下几个步骤：</p>
<ul class="simple">
<li>代码编写：按照ODPS UDF框架的规定，实现函数功能，并进行编译。下面给出一个简单的代码实现：</li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">alidata</span><span class="o">.</span><span class="na">odps</span><span class="o">.</span><span class="na">udf</span><span class="o">.</span><span class="na">examples</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.aliyun.odps.udf.UDF</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Lower</span> <span class="kd">extends</span> <span class="n">UDF</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">evaluate</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="k">return</span> <span class="kc">null</span><span class="o">;</span> <span class="o">}</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>将这个jar包命名为&#8221;my_lower.jar&#8221;。关于UDF编程框架的介绍请参考 <a class="reference internal" href="#odps-udf-udf"><em>UDF接口说明</em></a> 。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="last simple">
<li>ODPS为用户提供了便捷的Eclipse开发插件，方便用户快速开发UDF程序，并提供了本地调试UDF的功能。详细介绍请参考 <a class="reference internal" href="../odps_tools/odps_eclipse_plugin.html#odps-tool-eclipse-udf"><em>UDF开发插件介绍</em></a> 。</li>
<li>用户在打包时只需要将UDF程序自身的代码打包即可，不需要将依赖包(包括ODPS SDK及引用的第三方库)一起打入Jar包&gt;。在添加资源时，需要将依赖的包统一以资源形式加入ODPS。创建UDF时指定这些依赖的Jar资源。</li>
</ul>
</div>
<ul class="simple">
<li>添加资源：在运行UDF之前，用户需要将jar包以资源的形式上传到ODPS中。只有这样，UDF框架才能自动加载jar资源，运行用户的UDF程序。<a class="reference internal" href="../odps_mr/index.html#odps-open-mr"><em>MapReduce</em></a> 也用到了资源这一ODPS特有概念。</li>
</ul>
<p>执行命令：</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">create</span> <span class="n">resource</span> <span class="n">jar</span> <span class="n">my_lower</span><span class="p">.</span><span class="n">jar</span><span class="p">;</span>
    <span class="c1">-- 如果存在同名的资源请将这个jar包重命名，</span>
    <span class="c1">-- 并注意修改下面示例命令中相关jar包的名字；</span>
    <span class="c1">-- 又或者直接使用-f选项覆盖原有的jar资源</span>
</pre></div>
</div>
<ul class="simple">
<li>注册UDF函数：用户的jar包被上传后，使得ODPS有条件自动获取用户代码并运行。但此时仍然无法使用这个UDF，因为ODPS中并没有关于这个UDF的任何信息。因此需要用户在ODPS中注册一个唯一的函数名，并指定这个函数名与哪个jar资源的哪个函数对应。关于如何注册UDF，请参考 <a class="reference internal" href="../odps_common.html#odps-common-create-func"><em>创建函数</em></a> 。运行命令：</li>
</ul>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">create</span> <span class="k">function</span> <span class="n">test_lower</span> <span class="n">org</span><span class="p">.</span><span class="n">alidata</span><span class="p">.</span><span class="n">odps</span><span class="p">.</span><span class="n">udf</span><span class="p">.</span><span class="n">examples</span><span class="p">.</span><span class="k">Lower</span> <span class="n">my_lower</span><span class="p">.</span><span class="n">jar</span>
</pre></div>
</div>
<ul class="simple">
<li>运行SQL：在SQL中使用该UDF即可，使用方式与SQL内建函数类似：</li>
</ul>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">select</span> <span class="n">test_lower</span><span class="p">(</span><span class="n">shop_name</span><span class="p">)</span> <span class="k">from</span> <span class="n">sale_detail</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="udf-api">
<h2>UDF API<a class="headerlink" href="#udf-api" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id2">
<h3>参数与返回值类型<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>UDF支持ODPS SQL的数据类型有：bigint, string, double和boolean。目前不支持datetime类型。ODPS数据类型与Java类型的对应关系如下：</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="31%" />
<col width="17%" />
<col width="17%" />
<col width="17%" />
<col width="19%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>ODPS SQL Type</td>
<td>Bigint</td>
<td>String</td>
<td>Double</td>
<td>Boolean</td>
</tr>
<tr class="row-even"><td>Java Type</td>
<td>Long</td>
<td>String</td>
<td>Double</td>
<td>Boolean</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">SQL中的NULL值通过Java中的NULL引用表示，因此Java primitive type是不允许使用的，因为无法表示SQL中的NULL值。</p>
</div>
</div>
<div class="section" id="odps-udf-udf">
<span id="id3"></span><h3>UDF接口说明<a class="headerlink" href="#odps-udf-udf" title="Permalink to this headline">¶</a></h3>
<p>实现UDF需要继承com.aliyun.odps.udf.UDF类，并实现evaluate方法。evaluate方法必须是非static的public方法。Evaluate方法的参数和返回值类型将作为SQL中UDF的函数签名。这意味着用户可以在UDF中实现多个evaluate方法，在调用UDF时，框架会依据UDF调用的参数类型匹配正确的evaluate方法。</p>
<p>下面是一个UDF的例子。</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">alidata</span><span class="o">.</span><span class="na">odps</span><span class="o">.</span><span class="na">udf</span><span class="o">.</span><span class="na">examples</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.aliyun.odps.udf.UDF</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Lower</span> <span class="kd">extends</span> <span class="n">UDF</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">evaluate</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="k">return</span> <span class="kc">null</span><span class="o">;</span> <span class="o">}</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>UDF的使用方式于ODPS SQL中普通的内建函数相同，详情请参考 <a class="reference internal" href="odps_sql_func.html#odps-sql-function"><em>SQL内建函数</em></a></p>
</div>
<div class="section" id="udtf">
<h3>UDTF接口说明<a class="headerlink" href="#udtf" title="Permalink to this headline">¶</a></h3>
<p>Java UDTF需要继承com.aliyun.odps.udf.UDTF类。这个类需要实现4个接口。</p>
<table border="1" class="docutils">
<colgroup>
<col width="51%" />
<col width="49%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">接口定义</th>
<th class="head">描述</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><dl class="first last docutils">
<dt>public void setup(ExecutionContext ctx)</dt>
<dd>throws UDFException</dd>
</dl>
</td>
<td>初始化方法，在UDTF处理输入数据前，调用用户
自定义的初始化行为。在每个Worker内setup会
被先调用一次。</td>
</tr>
<tr class="row-odd"><td><dl class="first last docutils">
<dt>public void process(Object[] args)</dt>
<dd>throws UDFException</dd>
</dl>
</td>
<td>这个方法由框架调用，SQL中每一条记录都会对
应调用一次process，process的参数为SQL语句
中指定的UDTF输入参数。输入参数以Object[]的
形式传入，输出结果通过forward函数输出。用
户需要在process函数内自行调用forward，以决
定输出数据。</td>
</tr>
<tr class="row-even"><td>public void close() throws UDFException</td>
<td>UDTF的结束方法，此方法由框架调用，并且只会
被调用一次，即在处理完最后一条记录之后。</td>
</tr>
<tr class="row-odd"><td><dl class="first last docutils">
<dt>public void forward(Object ...o)</dt>
<dd>throws UDFException</dd>
</dl>
</td>
<td>用户调用forward方法输出数据，每次forward
代表输出一条记录。对应SQL语句UDTF的as子句
指定的列。</td>
</tr>
</tbody>
</table>
<p>下面将给出一个UDTF程序示例：</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">alidata</span><span class="o">.</span><span class="na">odps</span><span class="o">.</span><span class="na">udf</span><span class="o">.</span><span class="na">examples</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.aliyun.odps.udf.UDTF</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.aliyun.odps.udf.UDTFCollector</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.aliyun.odps.udf.annotation.Resolve</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.aliyun.odps.udf.UDFException</span><span class="o">;</span>

<span class="c1">// TODO define input and output types, e.g., &quot;string,string-&gt;string,bigint&quot;.</span>
<span class="nd">@Resolve</span><span class="o">({</span><span class="s">&quot;string,bigint-&gt;string,bigint&quot;</span><span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyUDTF</span> <span class="kd">extends</span> <span class="n">UDTF</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">UDFException</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">a</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
    <span class="n">Long</span> <span class="n">b</span> <span class="o">=</span> <span class="o">(</span><span class="n">Long</span><span class="o">)</span> <span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">];</span>

    <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="nl">t:</span> <span class="n">a</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&quot;\\s+&quot;</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">forward</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">b</span><span class="o">);</span>
    <span class="o">}</span>

  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>在SQL中可以这样使用这个UDTF，假设在ODPS上创建UDTF时注册函数名为user_udtf：</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">select</span> <span class="n">user_udtf</span><span class="p">(</span><span class="n">col0</span><span class="p">,</span> <span class="n">col1</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">c0</span><span class="p">,</span> <span class="n">c1</span><span class="p">)</span> <span class="k">from</span> <span class="n">my_table</span><span class="p">;</span>
</pre></div>
</div>
<p>假设my_table的col0， col1的值为：</p>
<div class="highlight-python"><pre>+------+------+
| col0 | col1 |
+------+------+
| A B  | 1    |
| C D  | 2    |
+------+------+</pre>
</div>
<p>则select出的结果为：</p>
<div class="highlight-python"><pre>+----+----+
| c0 | c1 |
+----+----+
| A  | 1  |
| B  | 1  |
| C  | 2  |
| D  | 2  |
+----+----+</pre>
</div>
<div class="section" id="odps-udtf-usage">
<span id="id4"></span><h4>UDTF使用说明<a class="headerlink" href="#odps-udtf-usage" title="Permalink to this headline">¶</a></h4>
<p>UDTF在SQL中的常用方式如下：</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">select</span> <span class="n">user_udtf</span><span class="p">(</span><span class="n">col0</span><span class="p">,</span> <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">c0</span><span class="p">,</span> <span class="n">c1</span><span class="p">)</span> <span class="k">from</span> <span class="n">my_table</span><span class="p">;</span>

<span class="k">select</span> <span class="n">user_udtf</span><span class="p">(</span><span class="n">col0</span><span class="p">,</span> <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">c0</span><span class="p">,</span> <span class="n">c1</span><span class="p">)</span> <span class="k">from</span>
    <span class="p">(</span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">my_table</span> <span class="n">distribute</span> <span class="k">by</span> <span class="k">key</span> <span class="n">sort</span> <span class="k">by</span> <span class="k">key</span><span class="p">)</span> <span class="n">t</span><span class="p">;</span>

<span class="k">select</span> <span class="n">reduce_udtf</span><span class="p">(</span><span class="n">col0</span><span class="p">,</span> <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">c0</span><span class="p">,</span> <span class="n">c1</span><span class="p">)</span> <span class="k">from</span>
    <span class="p">(</span><span class="k">select</span> <span class="n">col0</span><span class="p">,</span> <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span> <span class="k">from</span>
        <span class="p">(</span><span class="k">select</span> <span class="n">map_udtf</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">col0</span><span class="p">,</span> <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span><span class="p">)</span> <span class="k">from</span> <span class="n">my_table</span><span class="p">)</span> <span class="n">t1</span>
     <span class="n">distribute</span> <span class="k">by</span> <span class="n">col0</span> <span class="n">sort</span> <span class="k">by</span> <span class="n">col0</span><span class="p">,</span> <span class="n">col1</span><span class="p">)</span> <span class="n">t2</span><span class="p">;</span>
</pre></div>
</div>
<p>但使用UDTF有如下使用限制：</p>
<ul class="simple">
<li>同一个SELECT子句中不允许有其他表达式</li>
</ul>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">select</span> <span class="n">value</span><span class="p">,</span> <span class="n">user_udtf</span><span class="p">(</span><span class="k">key</span><span class="p">)</span> <span class="k">as</span> <span class="n">mycol</span> <span class="p">...</span>
</pre></div>
</div>
<ul class="simple">
<li>UDTF不能嵌套使用</li>
</ul>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">select</span> <span class="n">user_udtf1</span><span class="p">(</span><span class="n">user_udtf2</span><span class="p">(</span><span class="k">key</span><span class="p">))</span> <span class="k">as</span> <span class="n">mycol</span><span class="p">...</span>
</pre></div>
</div>
<ul class="simple">
<li>不支持在同一个select子句中与 group by / distribute by / sort by 联用</li>
</ul>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">select</span> <span class="n">user_udtf</span><span class="p">(</span><span class="k">key</span><span class="p">)</span> <span class="k">as</span> <span class="n">mycol</span> <span class="p">...</span> <span class="k">group</span> <span class="k">by</span> <span class="n">mycol</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h4>其他UDTF示例<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<p>在UDTF中，用户可以读取ODPS的 <a class="reference internal" href="../odps_common.html#odps-common-resource"><em>资源(Resource)</em></a> 。</p>
<div class="highlight-java"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">alidata</span><span class="o">.</span><span class="na">odps</span><span class="o">.</span><span class="na">mr</span><span class="o">.</span><span class="na">examples</span><span class="o">.</span><span class="na">udtf</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.BufferedInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.BufferedReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStreamReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.aliyun.odps.udf.ExecutionContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.aliyun.odps.udf.UDFException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.aliyun.odps.udf.UDTF</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.aliyun.odps.udf.annotation.Resolve</span><span class="o">;</span>

<span class="nd">@Resolve</span><span class="o">(</span><span class="s">&quot;string-&gt;string&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExampleUDTF</span> <span class="kd">extends</span> <span class="n">UDTF</span> <span class="o">{</span>

  <span class="n">ExecutionContext</span> <span class="n">ctx</span><span class="o">;</span>
  <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">replaceMap</span><span class="o">;</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setup</span><span class="o">(</span><span class="n">ExecutionContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">UDFException</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">ctx</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">;</span>
    <span class="n">replaceMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">BufferedInputStream</span> <span class="n">resource</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">readResourceFileAsStream</span><span class="o">(</span><span class="s">&quot;replace_map.txt&quot;</span><span class="o">);</span>
      <span class="n">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">InputStreamReader</span><span class="o">(</span><span class="n">resource</span><span class="o">));</span>
      <span class="n">String</span> <span class="n">st</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
      <span class="k">while</span> <span class="o">((</span><span class="n">st</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span><span class="o">[]</span> <span class="n">replaceStr</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">replaceStr</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nf">UDFException</span><span class="o">(</span><span class="s">&quot;resource format error.&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">replaceMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">replaceStr</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="n">replaceStr</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">UDFException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>

  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">UDFException</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">inputLine</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">replaceMap</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">inputLine</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">forward</span><span class="o">(</span><span class="n">replaceMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">inputLine</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">forward</span><span class="o">(</span><span class="n">inputLine</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</td></tr></table></div>
<p>说明：</p>
<blockquote>
<div><ul class="simple">
<li>25行：通过readResourceFileAsStream获取BufferedInputStream；</li>
<li>28 ~ 34行：将资源内容保存到replaceMap中；</li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">目前，ODPS还不支持在UDF中读取资源。在 <a class="reference internal" href="../odps_mr/index.html#odps-open-mr"><em>MapReduce</em></a> 中，用户同样可以使用相同的方式获取资源，请参考 <a class="reference internal" href="../odps_mr/example/Resource.html#odps-mr-resource-set"><em>资源使用示例</em></a> 。</p>
</div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">自定义函数(UDF)</a><ul>
<li><a class="reference internal" href="#odps-sql-udf-quickstart">快速开始(UDF的创建和使用)</a></li>
<li><a class="reference internal" href="#udf-api">UDF API</a><ul>
<li><a class="reference internal" href="#id2">参数与返回值类型</a></li>
<li><a class="reference internal" href="#odps-udf-udf">UDF接口说明</a></li>
<li><a class="reference internal" href="#udtf">UDTF接口说明</a><ul>
<li><a class="reference internal" href="#odps-udtf-usage">UDTF使用说明</a></li>
<li><a class="reference internal" href="#id5">其他UDTF示例</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="odps_sql_appendix.html" title="附录"
             >next</a></li>
        <li class="right" >
          <a href="odps_sql_func.html" title="SQL内建函数"
             >previous</a> |</li>
        <li><a href="../../index.html">ODPS 1.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >ODPS SQL</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright Alibaba 2014-07-01.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2b1.
    </div>
  <!-- 请把脚本放到 body 元素内 -->
  </body>
</html>