.. odps documentation master file, created by
   sphinx-quickstart on Mon Oct 29 16:56:37 2012.
   You can adapt this file completely to your liking, but it should at least
   contain the root `toctree` directive.

.. _odps_dship:

ODPS数据上传下载工具
=======================================

ODPS为用户提供了数据上传及下载的工具。用户可以从阿里云官网上下载这个工具。

下载安装
-------------
准备：
 * 正确安装java运行环境(JDK1.6)；
 * 下载dship安装文件，odps-dship.zip，解压缩；
 * 运行dship config命令配置accessid，accesskey及默认的project，详细请参考 :ref:`odps_tool_dship_config` ；

从阿里云官网上下载后，解压此文件，会看到如下目录及文件：

::

  odps.conf  dship  dship.bat  lib/

其中，dship是Linux系统下的可执行文件，dship.bat是Windows下的可执行文件，lib是工具依赖的库文件路径，odps.conf是配置文件。也可以编辑odps.conf，填写相关信息：

::

  tunnel-endpoint=<Tunnel服务的地址，请注意公网服务与内网服务的区别>
    #Tunnel服务内网地址：http://dt-ext.odps.aliyun-inc.com
    #Tunnel服务公网地址：http://dt.odps.aliyun.com
  id=<阿里云账号相关信息>
  key=<阿里云账号相关信息>
  project=<默认项目空间名称，配置此项后不必特殊指定数据导入、导出表所在的项目空间>

.. note:: 服务地址的选取会影响数据上传及下载的计费结果。详细介绍请参考 :ref:`odps_tunnel_sdk` 开篇的介绍。 

现在，您可以使用dship工具进行数据上传下载。

::
  
  配置dship上传信息
  > ./dship config （配置accessid, accesskey及default project）
  > ./dship config --tunnel-endpoint="http://xxx" (配置tunnel endpoint)

功能简介
-------------

* :ref:`odps_tool_dship_upload` ：支持文件或目录(只一级目录)的上传，每一次上传只支持数据上传到一个表或表的一个分区，有分区的表一定要指定上传的分区。

::

   dship upload  log.txt  test_project.test_table/p1="b1",p2="b2"
   dship upload  log.txt  test_table --scan=only
 
* :ref:`odps_tool_dship_download` ：只支持下载到单个文件，每一次下载只支持下载一个表或一个分区到一个文件，有分区的表一定要指定上传的分区。

::

   dship download  test_project.test_table/p1="b1",p2="b2"  log.txt

* :ref:`odps_tool_dship_resume` ：因为网络或tunnel服务的原因出错，dship支持文件或目录的续传。

::

   dship rerume

* :ref:`odps_tool_dship_show` ：显示历史任务信息。

::

   dship show bad
   dship show history -n 5
   dship show log

工具使用说明
--------------
通过help子命令获取帮助信息，每个命令和选择支持短命令格式：

::

  $ ./dship help
  Usage: dship <command> [options] [args]
  Type 'dship help <command>' for help on a specific subcommand.
  
  Available commands:
      upload (u)
      download (d)
      resume (r)
      show (s)
      config (c)
      purge (p)
      help (h)
  
  dship is tool for odps data transfer.
  

说明：

 * upload：帮助用户上传数据到ODPS的表中；
 * download：帮助用户从ODPS的表中下载数据；
 * resume：如果上传数据失败，通过resume命令进行断点续传，目前仅支持上传数据的续传。每次上传、下载数据被称为一个session。在resume命令后指定session id完成续传。
 * show：查看历史运行信息；
 * config：通过交互模式配置odps.conf文件信息；
 * help：输出dship帮助信息；

.. _odps_tool_dship_upload:

Upload
~~~~~~~~

将本地文件的数据导入ODPS的表中，以追加模式导入。子命令使用提示：

:: 

  $ ./dship help upload
  upload : upload data from local file.
  Usage: upload [options] <path> <[project.]table[/partition]>
  
  Valid options:
      -fd  [--field-delimiter] ARG         : field delimiter string
                                               default delimiter: ','
      -rd  [--record-delimiter] ARG        : record delimiter string
                                               default delimiter: '\n'
      -dfp [--date-format-pattern] ARG     : date format pattern
                                               default pattern: 'yyyyMMddHHmmss'
      -ni  [--null-indicator] ARG          : null indicator string
                                               default indicator: ''
      -c   [--charset] ARG                 : file charset
                                               default charset: 'UTF-8'
      -dbr [--discard-bad-records] ARG     : discard bad records
                                               default: 'false'
                                               limit operation ('true' or 'false').
      -s   [--scan] ARG                    : scan file or not
                                               default: 'true'
                                               limit operation ('true', 'false' or 'only').
  
  For example:
      dship upload  log.txt  test_project.test_table/p1='b1',p2='b2'

说明：

 * -fd：本地数据文件的列分割符，默认为逗号','；
 * -rd：本地数据文件的行分割符，默认为换行符'\n'；
 * -dfp：DateTime类型数据格式，默认为'yyyyMMddHHmmss'；
 * -ni：NULL数据标志符，默认为'NULL'；
 * -c：本地数据文件编码，默认为'UTF-8'；
 * -dbr：是否忽略脏数据(多列，少列，列数据类型不匹配等情况)。值为'true'时，将全部不符合表定义的数据忽略。值为'false'，若遇到脏数据，则给出错误提示信息，目标表内的原始数据不会被污染。
 * -s：是否扫描本地数据文件，默认扫描。值为'true'时，先扫描数据，若数据格式正确，再导入数据。值为'false'，不扫描数据，直接进行数据导入。值为'only'时，仅进行扫描本地数据，扫描结束后不继续导入数据。

程序示例：

创建目标表：

.. code-block:: sql

   CREATE TABLE IF NOT EXISTS sale_detail(
      shop_name     STRING,
      customer_id   STRING,
      total_price   DOUBLE)
  PARTITIONED BY (sale_date STRING,region STRING);

添加分区：


.. code-block:: sql

  alter table sale_detail add partition (sale_date='201312', region='hangzhou');

准备数据文件data.txt，其内容为：

::

  shop9,97,100
  shop10,10,200
  shop11,11

这份文件的第三行数据与sale_detail的表定义不符。sale_detail定义了三列，但数据只有两列。

导入数据：

::

  $ ./dship u data.txt sale_detail/sale_date=201312,region=hangzhou -s false
  Upload session: 2014040322463995e6e60a000049ce
  2014-04-03 22:46:39     uploading block 1
  ERROR: column mismatch - line 3, expected 3 found 2, please check data or delimiter


由于data.txt中有脏数据，数据导入失败。并给出session id及错误提示信息。

数据验证：

::

 odps:sql:odps_test_mrtask> select * from sale_detail where sale_date='201312';
 InstanceId: 20140403145013356gvg9tpna
 ....
 +-----------+-------------+-------------+-----------+--------+
 | shop_name | customer_id | total_price | sale_date | region |
 +-----------+-------------+-------------+-----------+--------+
 +-----------+-------------+-------------+-----------+--------+

由于有脏数据，数据导入失败，表中无数据。

.. _odps_tool_dship_show:

Show
~~~~~~~
显示历史记录。子命令使用提示：

:: 

  $ ./dship help show
  show : show session infomation.
  Usage: show history [options]
  
  Valid options:
      -n   [--number] ARG           : list history number
  
  Usage: show <command> [sessionid]
  Available commands:
      log                           : show log
      bad                           : show bad data
  
  For example:
      dship show history -n 5
      dship show log

命令示例：

::

  $ ./dship show  history
  2014040322463995e6e60a000049ce  'u data.txt sale_detail/sale_date=201312,region=hangzhou -s false '

说明：2014040322463995e6e60a000049ce是上节中导入数据失败时的运行id。

.. _odps_tool_dship_resume:

Resume
~~~~~~
修复执行历史记录，仅对上传数据有效。子命令使用提示：

:: 

  $ ./dship help resume
  resume : resume upload session.
  Usage: resume [session_id] [--force]
  
  For example:
      dship resume

命令示例：

修改data.txt文件为：

::

  shop9,97,100
  shop10,10,200

修复执行上传数据：

::

  $ ./dship resume 2014040322463995e6e60a000049ce --force
  Upload session: 2014040322463995e6e60a000049ce
  2014-04-03 22:55:48     uploading block 1
  Summary of 'a' upload:
          records: 2
          file size: 27 bytes

其中，2014040322463995e6e60a000049ce为上传失败的session id。  

数据验证：

::

 odps:sql:odps_test_mrtask> select * from sale_detail where sale_date='201312';
 InstanceId: 20140403145839556g3h9tpna
 ...
 +-----------+-------------+-------------+-----------+--------+
 | shop_name | customer_id | total_price | sale_date | region |
 +-----------+-------------+-------------+-----------+--------+
 | shop9     | 97          | 100.0       | 201312    | hangzhou |
 | shop10    | 10          | 200.0       | 201312    | hangzhou |
 +-----------+-------------+-------------+-----------+--------+
 
.. _odps_tool_dship_download:

Download
~~~~~~~~~

子命令使用提示：

:: 

  $ ./dship help download
  download : download data to local file.
  Usage: download [options] <[project.]table[/partition]> <path>
  
  Valid options:
      -fd  [--field-delimiter] ARG         : field delimiter string
                                               default delimiter: ','
      -rd  [--record-delimiter] ARG        : record delimiter string
                                               default delimiter: '\n'
      -dfp [--date-format-pattern] ARG     : date format pattern
                                               default pattern: 'yyyyMMddHHmmss'
      -ni  [--null-indicator] ARG          : null indicator string
                                               default indicator: ''
      -c   [--charset] ARG                 : file charset
                                               default charset: 'UTF-8'
  
  For example:
      dship download  test_project.test_table/p1='b1',p2='b2'  log.txt

说明：
 * -fd：本地数据文件的列分割符，默认为逗号','；
 * -rd：本地数据文件的行分割符，默认为换行符'\\n'；
 * -dfp：DateTime类型数据格式，默认为'yyyyMMddHHmmss'；
 * -ni：NULL数据标志符，默认为'NULL'；
 * -c：本地数据文件编码，默认为'UTF-8'；


命令示例：

下载数据到result.txt文件中：

::

  $ ./dship download sale_detail/sale_date=201312,region=hangzhou result.txt
  Download session: 2014040323013495e6e60a000049d5
  Summary of 'result' download:
          records: 6
          file size: 87 bytes
    
数据验证，result.txt的文件内容为：

::

 shop9,97,100.0
 shop10,10,200.0

.. _odps_tool_dship_config:
 
Config
~~~~~~~
通过交互式模式，配置odps.conf文件。子命令使用提示：

:: 

  $ ./dship help config
  config : config default option.
  Usage: config [options]
  
  Valid options:
      -fd  [--field-delimiter] ARG         : field delimiter
      -rd  [--record-delimiter] ARG        : record delimiter
      -dfp [--date-format-pattern] ARG     : date format pattern
      -ni  [--null-indicator] ARG          : null indicator string
      -c   [--charset] ARG                 : file charset
      -dbr [--discard-bad-records] ARG     : discard bad records
                                               action(true|false)
      -s   [--scan] ARG                    : scan file
                                               action(true|false|only)
      -e   [--endpoint] ARG                : specify endpoint
      -te  [--tunnel-endpoint] ARG        : specify tunnel endpoint
      -i   [--id] ARG                      : access id
      -k   [--key] ARG                     : access key
      -p   [--project] ARG                 : default project
  
  For example:
      dship config --project=test_project

命令示例：

::

  $ ./dship  config
  odps access id : 123
  odps access key : 123
  default project : 123

查看odps.conf文件内容：

::

  key=123
  endpoint=<保持原有内容不变>
  project=123
  id=123


.. _odps_tool_dship_purge:

Purge
~~~~~~
清除历史信息。子命令使用提示：

:: 

  ./dship help purge
  purge : delete session history.
  Usage: purge [n]
      force session history to be purged.([n] days before, default 3 days)
  
  For example:
      dship purge 5
 
数据类型说明
-------------
+---------+------------------------------------------------------------------------------------------+
| 类型    | 描述                                                                                     |
+=========+==========================================================================================+
| STRING  | 字符串类型，长度不能超过2M。                                                             |
+---------+------------------------------------------------------------------------------------------+
| BOOLEN  | 上传值只支持”true”，”false”，”0”，”1”。下载值为true/false且不区分大小写。                |
+---------+------------------------------------------------------------------------------------------+
| BIGINT  | 取值范围[-9223372036854775807，9223372036854775807]。                                    |
+---------+------------------------------------------------------------------------------------------+
| DOUBLE  | 1.有效位数16位                                                                           |
|         | 2.上传支持科学计数法表示                                                                 |
|         | 3.下载仅使用数字表示                                                                     |
|         | 4.最大值：1.7976931348623157E308                                                         |
|         | 5.最小值：4.9E-324                                                                       |
|         | 6.无穷大：Infinity                                                                       |
|         | 7.无穷小：-Infinity                                                                      |
+---------+------------------------------------------------------------------------------------------+
| DATETIME| Datetime类型只支持时区为GMT数据上传，可以通过命令行指定用户数据日期格式的format pattern。|
+---------+------------------------------------------------------------------------------------------+

如果用户上传DATETIME类型的数据，需要指定时间日期格式，具体格式可参考 `SimpleDateFormat <http://docs.oracle.com/javase/6/docs/api/java/text/SimpleDateFormat.html>`_ ：

::

  "yyyyMMddHHmmss"(默认): 数据格式"20140209101000"
  "yyyy-MM-dd HH:mm:ss"：数据格式"2014-02-09 10:10:00"
  "yyyy年MM月dd日": 数据格式"2014年09月01日"

示例：

::

   dship upload  log.txt  test_table –dfp  “yyyyMMddHHmmss”

分隔符
-------------
dship支持用户自定义的文件分隔符，行分隔符选项为"--record-delimiter"，列分隔符选项为"--field-delimiter"。
分隔符说明：
* 支持多个字符的行列分隔符
* 列分隔符不能够包含行分隔符
* 转意字符分隔符，在命令行方式下只支持\\r、\\n和\\t

示例：

::

  dship upload log.txt test_table –fd "||" –rd "\r\n"
  
空值
-------------
所有数据类型都可以有空值：
* 默认空字符串为空值。
* 可在命令行下通过--null-indicator参数来指定空值的字符串

::

 dship upload log.txt test_table –ni "NULL"
  
字符编码
-------------
  用户可以指定文件的字符编码，默认为"UTF-8"。

::

  dship upload log.txt test_table –c "gbk"
  
常见问题
-------------
1、Q:是否支持ascii字符的分隔符？
   A:命令行方式不支持，配置文件可以用十六进制表示：如\\u000A，表示回车。
2、Q:文件大小是否有限制？
   A:文件大小没有限制，但一个upload上传时间最多24小时，工具会根据当前上传文件的速度预测，如果上传时间预计超过20小时，会中止上传。如：当前上速度20MB/s，则最多一个上传文件或目录大小为1.4T。
3、Q: 记录大小是否有限制？
   A: 记录大小不能超过200M。
4、Q:是否要使用压缩？
   A:默认会使用压缩，如果带宽允许的情况下，可以关掉压缩。
5、Q:同一个表或partition是否可以并行上传？
   A:可以。
6、Q:什么时间续传使用--force参数？ 
   A:如果使用上传的进程被强制中断，如断电，可以使用—force参数强制上传。
7、Q:是否支持不同字符编码？
   A:支持不同的编码格式叁数，带bom标识文件不需要指定编码。
8、Q:导入成功脏数据怎么处理？
   A:导入成功，如果有脏数据可以通过./dship show dad [sessionid]导出脏数据，修改导出的脏数据文件再次上传，需要注意导出脏数据的编码格式，确定上传。
9、Q:上传下载的文件路径是否可以有空格
   A:可以有空格，参数需要用双引号括起来？
10、Q:为什么会出现乱码？
    A:可能是上传文件的字符编码和工具指定的编码不符。
11、Q: 导入的日期和显示为什么差8个小时？
    A: 上传工具使用的是GMT时区，而sql语句默认显示时区是GMT+8。
12、Q: windows下导入数据最后一列为什么多出"\\r"符号？
    A: windows下默认的换行符是"\\r\\n"，dship的列分隔符默认是"\\n"，所以把"\\r"作为数据内容导进去了。

